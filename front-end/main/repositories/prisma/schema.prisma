// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================
// USERS
// ============================
model Utilisateur {
  id        BigInt   @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  name      String   @db.VarChar(120)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  recipes          Recette[]
  inventaire       Inventaire?
  mealPlans        PlansRepas[]
  journal           Journal[]
  savedMeals       RepasEnregistre[]

  @@map("Utilisateur")
}

// ============================
// INGREDIENTS (global catalog)
// ============================
model Ingredients {
  id                  BigInt   @id @default(autoincrement())
  name                String   @unique @db.VarChar(255)
  kcalPer100g         Decimal  @default(0) @db.Decimal(8, 2) @map("kcal_per_100g")
  proteinGPer100g     Decimal  @default(0) @db.Decimal(8, 2) @map("protein_g_per_100g")
  carbsGPer100g       Decimal  @default(0) @db.Decimal(8, 2) @map("carbs_g_per_100g")
  fatGPer100g         Decimal  @default(0) @db.Decimal(8, 2) @map("fat_g_per_100g")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  recipeIngredients IngredientRecette[]
  inventaireItems   InventaireIngredient[]

  @@map("Ingredients")
}

// ============================
// RECIPES
// ============================
model Recette {
  id                    BigInt   @id @default(autoincrement())
  userId                BigInt?  @map("user_id")
  name                  String   @db.VarChar(255)
  servings              Decimal  @default(1.00) @db.Decimal(6, 2)
  
  // Cached per-serving nutrition (denormalized for speed)
  kcalPerServing        Decimal  @default(0) @db.Decimal(10, 2) @map("kcal_per_serving")
  proteinGPerServing    Decimal  @default(0) @db.Decimal(10, 2) @map("protein_g_per_serving")
  carbsGPerServing      Decimal  @default(0) @db.Decimal(10, 2) @map("carbs_g_per_serving")
  fatGPerServing        Decimal  @default(0) @db.Decimal(10, 2) @map("fat_g_per_serving")
  
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user                Utilisateur? @relation(fields: [userId], references: [id], onDelete: SetNull)
  ingredients         IngredientRecette[]
  mealPlanItems       PlansRepasRecette[]
  journalEntries      Journal[]
  savedMeals          RepasEnregistre[]

  @@map("Recette")
}

// Junction table: Recipes & Ingredients (quantities in grams)
model IngredientRecette {
  recipeId      BigInt  @map("recipe_id")
  ingredientId  BigInt  @map("ingredient_id")
  qtyGrams      Decimal @db.Decimal(12, 3) @map("qty_grams")
  notes         String? @db.VarChar(255)

  // Relations
  recipe        Recette @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient    Ingredients @relation(fields: [ingredientId], references: [id], onDelete: Restrict)

  @@id([recipeId, ingredientId])
  @@map("Ingredients_Recette")
}

// ============================
// INVENTORY
// ============================
model Inventaire {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user      Utilisateur @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     InventaireIngredient[]

  @@map("Inventaire")
}

// Current stock per ingredient
model InventaireIngredient {
  inventaireId  BigInt  @map("inventaire_id")
  ingredientId  BigInt  @map("ingredient_id")
  qtyGrams      Decimal @default(0) @db.Decimal(14, 3) @map("qty_grams")

  // Relations
  inventaire    Inventaire @relation(fields: [inventaireId], references: [id], onDelete: Cascade)
  ingredient    Ingredients @relation(fields: [ingredientId], references: [id], onDelete: Restrict)

  @@id([inventaireId, ingredientId])
  @@map("Inventaire_Ingredient")
}

// ============================
// WEEKLY MEAL PLANS
// ============================
model PlansRepas {
  id            BigInt   @id @default(autoincrement())
  userId        BigInt   @map("user_id")
  weekStartDate DateTime @db.Date @map("week_start_date")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user          Utilisateur @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         PlansRepasRecette[]

  @@unique([userId, weekStartDate], name: "uq_user_week")
  @@map("PlansRepas")
}

// Planned items inside a plan
enum MealType {
  breakfast
  lunch
  dinner
  snack
}

model PlansRepasRecette {
  id              BigInt   @id @default(autoincrement())
  planId          BigInt   @map("plan_id")
  date            DateTime @db.Date
  mealType        MealType @map("meal_type")
  recipeId        BigInt   @map("recipe_id")
  plannedServings Decimal  @default(1.00) @db.Decimal(6, 2) @map("planned_servings")

  // Relations
  plan            PlansRepas @relation(fields: [planId], references: [id], onDelete: Cascade)
  recipe          Recette @relation(fields: [recipeId], references: [id], onDelete: Restrict)

  @@index([planId, date, mealType], name: "k_plan_day")
  @@map("PlansRepas_Recette")
}

// ============================
// JOURNAL (logged meals)
// ============================
model Journal {
  id          BigInt   @id @default(autoincrement())
  userId      BigInt   @map("user_id")
  recipeId    BigInt   @map("recipe_id")
  servingsEaten Decimal @default(1.00) @db.Decimal(6, 2) @map("servings_eaten")
  loggedAt    DateTime @default(now()) @map("logged_at") @db.DateTime()

  // Snapshot nutrition at log time
  kcal        Decimal  @db.Decimal(12, 2)
  proteinG    Decimal  @db.Decimal(12, 2) @map("protein_g")
  carbsG      Decimal  @db.Decimal(12, 2) @map("carbs_g")
  fatG        Decimal  @db.Decimal(12, 2) @map("fat_g")

  // Relations
  user        Utilisateur @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe      Recette @relation(fields: [recipeId], references: [id], onDelete: Restrict)

  @@index([userId, loggedAt], name: "k_journal_user_time")
  @@map("Journal")
}

// ============================
// SAVED MEALS
// ============================
model RepasEnregistre {
  id              BigInt   @id @default(autoincrement())
  userId          BigInt   @map("user_id")
  name            String   @db.VarChar(255)
  recipeId        BigInt   @map("recipe_id")
  defaultServings Decimal  @default(1.00) @db.Decimal(6, 2) @map("default_servings")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user            Utilisateur @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe          Recette @relation(fields: [recipeId], references: [id], onDelete: Restrict)

  @@map("RepasEnregistre")
}
